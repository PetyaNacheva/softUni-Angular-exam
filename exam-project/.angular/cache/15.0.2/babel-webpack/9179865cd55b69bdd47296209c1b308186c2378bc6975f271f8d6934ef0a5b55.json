{"ast":null,"code":"import { BehaviorSubject, EMPTY } from 'rxjs';\nimport { catchError, map, tap } from 'rxjs/operators';\nimport { environment } from 'src/environments/environment';\nimport { login, logout } from './+store';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"@ngrx/store\";\nexport class AuthService {\n  constructor(httpClient, store) {\n    this.httpClient = httpClient;\n    this.store = store;\n    this._currentUser = new BehaviorSubject(undefined);\n    // currentUser$ = this._currentUser.asObservable();\n    this.currentUser$ = this.store.select(globalState => globalState.currentUser);\n    this.isLoggedIn$ = this.currentUser$.pipe(map(user => !!user));\n  }\n  login$(userData) {\n    return this.httpClient.post(`${environment.apiUrl}/login`, userData, {\n      withCredentials: true,\n      observe: 'response'\n    }).pipe(map(response => response.body));\n  }\n  logout$() {\n    return this.httpClient.post(`${environment.apiUrl}/logout`, {}, {\n      withCredentials: true\n    });\n  }\n  register$(userData) {\n    return this.httpClient.post(`${environment.apiUrl}/register`, userData, {\n      withCredentials: true\n    });\n  }\n  authenticate() {\n    return this.httpClient.get(`${environment.apiUrl}/users/profile`, {\n      withCredentials: true\n    }).pipe(tap(currentProfile => this.handleLogin(currentProfile)), catchError(err => {\n      return EMPTY;\n    }));\n  }\n  handleLogin(newUser) {\n    this.store.dispatch(login(newUser));\n    // this._currentUser.next(newUser);\n  }\n\n  handleLogout() {\n    this.store.dispatch(logout());\n    // this._currentUser.next(undefined);\n  }\n}\n\nAuthService.ɵfac = function AuthService_Factory(t) {\n  return new (t || AuthService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.Store));\n};\nAuthService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: AuthService,\n  factory: AuthService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"mappings":"AAGA,SAASA,eAAe,EAAEC,KAAK,QAAoB,MAAM;AACzD,SAASC,UAAU,EAAEC,GAAG,EAAEC,GAAG,QAAQ,gBAAgB;AACrD,SAASC,WAAW,QAAQ,8BAA8B;AAC1D,SAAqBC,KAAK,EAAEC,MAAM,QAAQ,UAAU;;;;AAOpD,OAAM,MAAOC,WAAW;EAOtBC,YAAoBC,UAAsB,EAAUC,KAAwB;IAAxD,eAAU,GAAVD,UAAU;IAAsB,UAAK,GAALC,KAAK;IANjD,iBAAY,GAAG,IAAIX,eAAe,CAAQY,SAAS,CAAC;IAE5D;IACA,iBAAY,GAAG,IAAI,CAACD,KAAK,CAACE,MAAM,CAACC,WAAW,IAAIA,WAAW,CAACC,WAAW,CAAC;IACxE,gBAAW,GAAG,IAAI,CAACC,YAAY,CAACC,IAAI,CAACd,GAAG,CAACe,IAAI,IAAI,CAAC,CAACA,IAAI,CAAC,CAAC;EAIzD;EAEAC,MAAM,CAACC,QAA6C;IAClD,OAAO,IAAI,CAACV,UAAU,CACnBW,IAAI,CAAQ,GAAGhB,WAAW,CAACiB,MAAM,QAAQ,EAAEF,QAAQ,EAAE;MAAEG,eAAe,EAAE,IAAI;MAAEC,OAAO,EAAE;IAAU,CAAE,CAAC,CACpGP,IAAI,CACHd,GAAG,CAACsB,QAAQ,IAAIA,QAAQ,CAACC,IAAI,CAAC,CAC/B;EACL;EAEAC,OAAO;IACL,OAAO,IAAI,CAACjB,UAAU,CACnBW,IAAI,CAAO,GAAGhB,WAAW,CAACiB,MAAM,SAAS,EAAE,EAAE,EAAE;MAAEC,eAAe,EAAE;IAAI,CAAE,CAAC;EAC9E;EAEAK,SAAS,CAACR,QAAuB;IAC/B,OAAO,IAAI,CAACV,UAAU,CAACW,IAAI,CAAQ,GAAGhB,WAAW,CAACiB,MAAM,WAAW,EAAEF,QAAQ,EAAE;MAAEG,eAAe,EAAE;IAAI,CAAE,CAAC;EAC3G;EAEAM,YAAY;IACV,OAAO,IAAI,CAACnB,UAAU,CACnBoB,GAAG,CAAQ,GAAGzB,WAAW,CAACiB,MAAM,gBAAgB,EAAE;MAAEC,eAAe,EAAE;IAAI,CAAE,CAAC,CAC5EN,IAAI,CAACb,GAAG,CAAC2B,cAAc,IAAI,IAAI,CAACC,WAAW,CAACD,cAAc,CAAC,CAAC,EAAE7B,UAAU,CAAE+B,GAAG,IAAI;MAChF,OAAOhC,KAAK;IACd,CAAC,CAAC,CAAC;EACP;EAEA+B,WAAW,CAACE,OAAc;IACxB,IAAI,CAACvB,KAAK,CAACwB,QAAQ,CAAC7B,KAAK,CAAC4B,OAAO,CAAC,CAAC;IACnC;EACF;;EAEAE,YAAY;IACV,IAAI,CAACzB,KAAK,CAACwB,QAAQ,CAAC5B,MAAM,EAAE,CAAC;IAC7B;EACF;;;;mBA5CWC,WAAW;AAAA;;SAAXA,WAAW;EAAA6B,SAAX7B,WAAW;EAAA8B,YAFV;AAAM","names":["BehaviorSubject","EMPTY","catchError","map","tap","environment","login","logout","AuthService","constructor","httpClient","store","undefined","select","globalState","currentUser","currentUser$","pipe","user","login$","userData","post","apiUrl","withCredentials","observe","response","body","logout$","register$","authenticate","get","currentProfile","handleLogin","err","newUser","dispatch","handleLogout","factory","providedIn"],"sourceRoot":"","sources":["D:\\Softuni\\softUni-Angular\\exam-project\\src\\app\\auth.service.ts"],"sourcesContent":["import { HttpClient } from '@angular/common/http';\nimport { Injectable } from '@angular/core';\nimport { Store } from '@ngrx/store';\nimport { BehaviorSubject, EMPTY, Observable } from 'rxjs';\nimport { catchError, map, tap } from 'rxjs/operators';\nimport { environment } from 'src/environments/environment';\nimport { IRootState, login, logout } from './+store';\nimport { IUser } from './core/interfaces';\nimport { CreateUserDto } from './core/user.service';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class AuthService {\n  private _currentUser = new BehaviorSubject<IUser>(undefined);\n\n  // currentUser$ = this._currentUser.asObservable();\n  currentUser$ = this.store.select(globalState => globalState.currentUser);\n  isLoggedIn$ = this.currentUser$.pipe(map(user => !!user));\n\n  constructor(private httpClient: HttpClient, private store: Store<IRootState>) {\n    \n  }\n\n  login$(userData: { email: string, password: string }): Observable<IUser> {\n    return this.httpClient\n      .post<IUser>(`${environment.apiUrl}/login`, userData, { withCredentials: true, observe: 'response' })\n      .pipe(\n        map(response => response.body),\n      )\n  }\n\n  logout$(): Observable<void> {\n    return this.httpClient\n      .post<void>(`${environment.apiUrl}/logout`, {}, { withCredentials: true })\n  }\n\n  register$(userData: CreateUserDto): Observable<IUser> {\n    return this.httpClient.post<IUser>(`${environment.apiUrl}/register`, userData, { withCredentials: true })\n  }\n\n  authenticate(): Observable<IUser> {\n    return this.httpClient\n      .get<IUser>(`${environment.apiUrl}/users/profile`, { withCredentials: true })\n      .pipe(tap(currentProfile => this.handleLogin(currentProfile)), catchError((err) => {\n        return EMPTY;\n      }))\n  }\n\n  handleLogin(newUser: IUser) {\n    this.store.dispatch(login(newUser))\n    // this._currentUser.next(newUser);\n  }\n\n  handleLogout() {\n    this.store.dispatch(logout());\n    // this._currentUser.next(undefined);\n  }\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}